var SUPLEXUI=SUPLEXUI||{};SUPLEXUI.admin=function(){var $btnOpenSuplexFileStore=$("#btnOpenSuplexFileStore"),$dlgFileExplorer,$tvFileExplorer,$grdSecurityPrincipals=$("#grdSecurityPrincipals"),vm=kendo.observable({isConnected:!1,hasChanges:!1,fileName:"",showSecureObjects:!1,showUsersGroups:function(){return!this.get("showSecureObjects")},selectedUsersGroups:{uid:"",source:""},save:function(){this.set("hasChanges",!1)},remove:function(){confirm("Are you sure you want to delete?")&&this.change()},change:function(){this.set("hasChanges",!0)},startOver:function(){this.set("isConnected",!1);this.set("hasChanges",!1);this.set("fileName","");this.set("showSecureObjects",!1);this.set("usersGroupsItemSelected",!1);this.selectedUsersGroups.set("uid","");this.selectedUsersGroups.set("source","")}}),storeEventWatch=new kendo.observable;storeEventWatch.bind("storeSelected",function(e){loadFile(e.fileName)});storeEventWatch.bind("storeLoaded",function(e){vm.startOver();vm.set("isConnected",!0);vm.set("fileName",e.fileName);grdSecurityPrincipalsRefresh()});storeEventWatch.bind("storeNew",function(){vm.startOver();grdSecurityPrincipalsRefresh()});var init=function(){createFileExplorerDialog();kendo.bind(document.body,vm)},switchView=function(e){vm.set("showSecureObjects",e.id=="secureobjects")},getActionUrl=function(action,controller){return $("base").attr("href")+controller+"/"+action},dsFileExplorer=new kendo.data.HierarchicalDataSource({transport:{read:{url:getActionUrl("GetDirectoryContents","Admin"),dataType:"json"}},schema:{model:{id:"Path",hasChildren:function(node){return node.spriteCssClass=node.Type=="File"?"file":"folder",node.HasChildren}}}}),createFileExplorerDialog=function(){$dlgFileExplorer=$("#dlgFileExplorer").kendoDialog({width:"400px",visible:!1,title:"File explorer",closable:!0,modal:!1,content:"<div id='tvFileExplorer'><\/div>",open:function(){dsFileExplorer.read()},actions:[{text:"Cancel"},{text:"OK",primary:!0,action:dlgFileExplorerActionOK}]});$tvFileExplorer=$("#tvFileExplorer").kendoTreeView({autoBind:!1,dataSource:dsFileExplorer,dataTextField:"Name"})},dlgFileExplorerActionOK=function(){var ok=!1,selected=$tvFileExplorer.data("kendoTreeView").select(),item=$tvFileExplorer.data("kendoTreeView").dataItem(selected);return item?item.Type!="File"?kendo.alert("Select a file"):(storeEventWatch.trigger("storeSelected",{fileName:item.Path}),ok=!0):kendo.alert("Select a file"),ok},loadFile=function(fileName){var ok=!1;return $.ajax({async:!1,method:"GET",url:getActionUrl("LoadFile","Admin"),data:{fileName:fileName},dataType:"json"}).done(function(data){data.Status=="success"?ok=!0:showNotification(data.ResponseText,"error")}).fail(function(){ok=!1;showNotification("There was a problem reading the file","error")}),ok&&storeEventWatch.trigger("storeLoaded",{fileName:fileName}),ok},grdSecurityPrincipalsChange=function(e){console.log("Security principal selection change");console.log(e);var selectedItem=e.sender.dataItem(this.select());console.log(selectedItem.Uid);console.log(selectedItem.IsUser);selectedItem.IsUser?(console.log("Call GetUserByUid"),vm.set("usersGroupsItemSelected",!0)):(console.log("Call GetGroupByUid"),vm.set("usersGroupsItemSelected",!0))},grdSecurityPrincipalsRefresh=function(){$grdSecurityPrincipals.data("kendoGrid").dataSource.data([]);$grdSecurityPrincipals.data("kendoGrid").dataSource.read()},newFile=function(){var ok=verifySaveChangesToStore();ok&&($.ajax({async:!1,method:"POST",url:getActionUrl("NewFile","Admin"),dataType:"json"}).done(function(data){data.Status!="success"?(showNotification("Unable to initialize suplex store","error"),ok=!1):ok=!0}).fail(function(xhr){showNotification("Unable to initialize suplex store","error");console.log(xhr);ok=!1}),ok&&storeEventWatch.trigger("storeNew"))},openFile=function(){var ok=verifySaveChangesToStore();ok&&$dlgFileExplorer.data("kendoDialog").open()},verifySaveChangesToStore=function(){var ok=!1;return vm.hasChanges?(kendo.confirm("Save changes to "+vm.get("fileName")),console.log("shd prompt for save")):ok=!0,ok},showNotification=function(msg,msgType,allowHideAfter,autoHideAfter){if(allowHideAfter===undefined&&(allowHideAfter=1e4),autoHideAfter===undefined&&(autoHideAfter=15e3),msg!=null){const id="#noti";var noti=$(id).data("kendoNotification");noti&&(noti.destroy(),$(id).empty());noti=$(id).kendoNotification({stacking:"up",position:{bottom:12,left:12},button:!0,allowHideAfter:allowHideAfter,autoHideAfter:autoHideAfter,hideOnClick:!1}).data("kendoNotification");noti.show(msg,msgType)}},dataSourceError=function(e){if(this.data([]),e){var msg=decipherJqXhrError(e.xhr,e.status);e.errors&&$.each(e.errors,function(key,value){"errors"in value&&$.each(value.errors,function(){msg+=this+"\n"})});showNotification(msg,"error")}};return{init:init,switchView:switchView,grdSecurityPrincipalsChange:grdSecurityPrincipalsChange,openFile:openFile,newFile:newFile,dlgFileExplorerActionOK:dlgFileExplorerActionOK,showNotification:showNotification}}();